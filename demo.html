<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HCERT Validation Demo</title>
    <style>
        textarea, button, input {
            display: block;
        }
    </style>
    <script src="build/distributions/hcert-kotlin.js"></script>
    <script>
        var verifier;

        document.onload = function () {
            let tQR = document.getElementById("tQR");
            let tCert = document.getElementById("tCert");
            let tRes = document.getElementById("tRes");
            let tValid = document.getElementById("tValid");
            let tError = document.getElementById("tError");
            let tMeta = document.getElementById("tMeta");
            let tEgc = document.getElementById("tEgc");
            tRes.value = "";
            tValid.value = "";
            tError.value = "";
            tMeta.value = "";
            tEgc.value = "";
        }

        function validate() {
            let qr = tQR.value.trim();
            let pemCert = tCert.value.trim();
            tRes.value = "Verifying ...";
            verifier = new hcert.VerifierDirect([pemCert]);
            let result = verifier.verify(qr);
            console.info(result);
            tRes.value = JSON.stringify(result, null, 2);
            tValid.value = JSON.stringify(result.isValid, null, 2);
            tError.value = JSON.stringify(result.error, null, 2);
            tMeta.value = JSON.stringify(result.metaInformation, null, 2);
            tEgc.value = JSON.stringify(result.greenCertificate, null, 2);
        }

        function downloadBinary(requestUrl, callback) {
            console.log("Downloading " + requestUrl + " ...")
            var xhr = new XMLHttpRequest();
            xhr.open("GET", requestUrl);
            xhr.responseType = "arraybuffer";
            xhr.onload = function () {
                if (this.status === 200) {
                    callback(xhr.response);
                } else {
                    console.warn(this);
                }
            };
            xhr.send();
        }

        function validateTrustList() {
            let qr = tQR.value.trim();
            let pemCert = tTrustListRoot.value.trim();
            tRes.value = "Verifying ...";
            let contentUrl = document.getElementById("tTrustListContentUrl").value.trim();
            let signatureUrl = document.getElementById("tTrustListSignatureUrl").value.trim();
            downloadBinary(contentUrl, function (resultContent) {
                downloadBinary(signatureUrl, function (resultSignature) {
                    verifier = new hcert.VerifierTrustList(pemCert, resultContent, resultSignature);
                    let result = verifier.verify(qr);
                    console.info(result);
                    tRes.value = JSON.stringify(result, null, 2);
                    tValid.value = JSON.stringify(result.isValid, null, 2);
                    tError.value = JSON.stringify(result.error, null, 2);
                    tMeta.value = JSON.stringify(result.metaInformation, null, 2);
                    tEgc.value = JSON.stringify(result.greenCertificate, null, 2);
                })
            });
        }

        function updateTrustList() {
            let pemCert = tTrustListRoot.value.trim();
            tRes.value = "Updating TrustList ...";
            let contentUrl = document.getElementById("tTrustListContentUrl").value.trim();
            let signatureUrl = document.getElementById("tTrustListSignatureUrl").value.trim();
            downloadBinary(contentUrl, function (resultContent) {
                downloadBinary(signatureUrl, function (resultSignature) {
                    verifier.updateTrustList(pemCert, resultContent, resultSignature);
                    tRes.value = "Updated TrustList!";
                })
            });
        }
    </script>
</head>
<body>

<h1>Input</h1>
<p>
    <label for="tQR">QR Code Contents</label><textarea rows="10" cols="100" id="tQR">HC1:NCFTW2H:7*I06R3W/J:O6:P4QB3+7RKFVJWV66UBCE//UXDT:*ML-4D.NBXR+SRHMNIY6EB8I595+6UY9-+0DPIO6C5%0SBHN-OWKCJ6BLC2M.M/NPKZ4F3WNHEIE6IO26LB8:F4:JVUGVY8*EKCLQ..QCSTS+F$:0PON:.MND4Z0I9:GU.LBJQ7/2IJPR:PAJFO80NN0TRO1IB:44:N2336-:KC6M*2N*41C42CA5KCD555O/A46F6ST1JJ9D0:.MMLH2/G9A7ZX4DCL*010LGDFI$MUD82QXSVH6R.CLIL:T4Q3129HXB8WZI8RASDE1LL9:9NQDC/O3X3G+A:2U5VP:IE+EMG40R53CG9J3JE1KB KJA5*$4GW54%LJBIWKE*HBX+4MNEIAD$3NR E228Z9SS4E R3HUMH3J%-B6DRO3T7GJBU6O URY858P0TR8MDJ$6VL8+7B5$G CIKIPS2CPVDK%K6+N0GUG+TG+RB5JGOU55HXDR.TL-N75Y0NHQTZ3XNQMTF/ZHYBQ$8IR9MIQHOSV%9K5-7%ZQ/.15I0*-J8AVD0N0/0USH.3</textarea>
</p>

<h2>Direct Verifier</h2>
<p>
    <label for="tCert">PEM-encoded DSC</label><textarea rows="10" cols="100" id="tCert">
    -----BEGIN CERTIFICATE-----
MIIBvTCCAWOgAwIBAgIKAXk8i88OleLsuTAKBggqhkjOPQQDAjA2MRYwFAYDVQQD
DA1BVCBER0MgQ1NDQSAxMQswCQYDVQQGEwJBVDEPMA0GA1UECgwGQk1TR1BLMB4X
DTIxMDUwNTEyNDEwNloXDTIzMDUwNTEyNDEwNlowPTERMA8GA1UEAwwIQVQgRFND
IDExCzAJBgNVBAYTAkFUMQ8wDQYDVQQKDAZCTVNHUEsxCjAIBgNVBAUTATEwWTAT
BgcqhkjOPQIBBggqhkjOPQMBBwNCAASt1Vz1rRuW1HqObUE9MDe7RzIk1gq4XW5G
TyHuHTj5cFEn2Rge37+hINfCZZcozpwQKdyaporPUP1TE7UWl0F3o1IwUDAOBgNV
HQ8BAf8EBAMCB4AwHQYDVR0OBBYEFO49y1ISb6cvXshLcp8UUp9VoGLQMB8GA1Ud
IwQYMBaAFP7JKEOflGEvef2iMdtopsetwGGeMAoGCCqGSM49BAMCA0gAMEUCIQDG
2opotWG8tJXN84ZZqT6wUBz9KF8D+z9NukYvnUEQ3QIgdBLFSTSiDt0UJaDF6St2
bkUQuVHW6fQbONd731/M4nc=
-----END CERTIFICATE-----
</textarea>
</p>
<p>
    <button onClick="validate()">Validate</button>
</p>

<h2>TrustList Verifier</h2>
<p>
    <label for="tTrustListRoot">PEM-encoded Root of TrustList</label><textarea rows="10" cols="100" id="tTrustListRoot">
-----BEGIN CERTIFICATE-----
MIIBJTCBy6ADAgECAgUAwvEVkzAKBggqhkjOPQQDAjAQMQ4wDAYDVQQDDAVFQy1N
ZTAeFw0yMTA0MjMxMTI3NDhaFw0yMTA1MjMxMTI3NDhaMBAxDjAMBgNVBAMMBUVD
LU1lMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE/OV5UfYrtE140ztF9jOgnux1
oyNO8Bss4377E/kDhp9EzFZdsgaztfT+wvA29b7rSb2EsHJrr8aQdn3/1ynte6MS
MBAwDgYDVR0PAQH/BAQDAgWgMAoGCCqGSM49BAMCA0kAMEYCIQC51XwstjIBH10S
N701EnxWGK3gIgPaUgBN+ljZAs76zQIhAODq4TJ2qAPpFc1FIUOvvlycGJ6QVxNX
EkhRcgdlVfUb
-----END CERTIFICATE-----
</textarea>
</p>
<p>
    <label for="tTrustListContentUrl">URL of TrustList Content File</label><textarea rows="1" cols="100"
                                                                                     id="tTrustListContentUrl">
https://dgc.a-sit.at/ehn/cert/listv2</textarea>
</p>
<p>
    <label for="tTrustListSignatureUrl">URL of TrustList Signature File</label><textarea rows="1" cols="100"
                                                                                         id="tTrustListSignatureUrl">
https://dgc.a-sit.at/ehn/cert/sigv2</textarea>
</p>
<p>
    <button onClick="validateTrustList()">Validate with TrustList</button>
</p>
<p>
    <button onClick="updateTrustList()">Update TrustList</button>
</p>


<h1>Result</h1>
<p>
    <label for="tRes">Overall Structure</label><textarea rows="60" cols="100" id="tRes" disabled></textarea>
</p>
<p>
    <label for="tValid">IsValid</label><textarea rows="5" cols="100" id="tValid" disabled></textarea>
</p>
<p>
    <label for="tError">Error</label><textarea rows="5" cols="100" id="tError" disabled></textarea>
</p>
<p>
    <label for="tMeta">Meta Information</label><textarea rows="30" cols="100" id="tMeta" disabled></textarea>
</p>
<p>
    <label for="tEgc">Green Certificate</label><textarea rows="30" cols="100" id="tEgc" disabled></textarea>
</p>


</body>
</html>